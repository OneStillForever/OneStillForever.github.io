# postgresqlâ†’syslog

# âœ… ìµœì¢… ëª©í‘œ

**Cisco ì¥ë¹„ì—ì„œ ë°œìƒí•˜ëŠ” Syslog ë¡œê·¸ë¥¼ PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ì— ìë™ ì €ì¥**

---

# ğŸ§­ 1. ì „ì²´ íë¦„ ìš”ì•½

```
swift
ë³µì‚¬í¸ì§‘
Cisco ì¥ë¹„ â”€â”€(Syslog UDP/TCP)â”€â”€â–¶ Linux ì„œë²„(RSyslog ìˆ˜ì‹ ) â”€â”€â–¶ /var/log/messages
    â”‚
    â””â”€[ë¡œê·¸ ì „ì†¡ ì„¤ì • í•„ìš”]

Linux ì„œë²„ â”€â”€â–¶ Python íŒŒì„œ(script) ì‹¤í–‰ â”€â”€â–¶ PostgreSQL DBì— INSERT

```

---

# ğŸ“¦ 2. ì‹œìŠ¤í…œ êµ¬ì„±

| êµ¬ì„± ìš”ì†Œ | ì„¤ëª… |
| --- | --- |
| **Cisco ì¥ë¹„** | syslogë¥¼ ì™¸ë¶€ë¡œ ì „ì†¡í•˜ë„ë¡ ì„¤ì • |
| **Linux ì„œë²„** | RSyslog ì„¤ì¹˜ ë° ìˆ˜ì‹  ì„¤ì • (TCP/UDP) |
| **PostgreSQL** | ë¡œê·¸ ì €ì¥ìš© DB (`syslog`), í…Œì´ë¸” (`tacacs_logs`) |
| **Python íŒŒì„œ** | `/var/log/messages` ì½ì–´ DBì— INSERT |

---

# ğŸ› ï¸ 3. êµ¬ì„± ë‹¨ê³„ë³„ ìƒì„¸ ì ˆì°¨

---

## âœ… [1] PostgreSQL ì¤€ë¹„

1. PostgreSQL ì„¤ì¹˜ ë° ì‹œì‘
2. DB ìƒì„±:

```bash
bash
ë³µì‚¬í¸ì§‘
createdb -U postgres syslog

```

1. ì‚¬ìš©ì ìƒì„± ë° ê¶Œí•œ ë¶€ì—¬:

```sql
sql
ë³µì‚¬í¸ì§‘
CREATE USER syslogdb WITH PASSWORD 'password';
GRANT CONNECT ON DATABASE syslog TO syslogdb;

```

1. í…Œì´ë¸” ìƒì„±:

```sql
sql
ë³µì‚¬í¸ì§‘
CREATE TABLE tacacs_logs (
    id SERIAL PRIMARY KEY,
    log_time TIMESTAMP,
    hostname TEXT,
    service TEXT,
    message TEXT
);

```

1. `pg_hba.conf` ìˆ˜ì • (ì˜ˆ: `/var/lib/pgsql/data/pg_hba.conf`):

```
conf
ë³µì‚¬í¸ì§‘
host    syslog    syslogdb    127.0.0.1/32    md5

```

1. PostgreSQL ì¬ì‹œì‘:

```bash
bash
ë³µì‚¬í¸ì§‘
sudo systemctl restart postgresql

```

---

## âœ… [2] RSyslog ì„¤ì •

1. `rsyslog.conf` ë˜ëŠ” `/etc/rsyslog.d/cisco.conf`ì— ìˆ˜ì‹  ì„¤ì • ì¶”ê°€:

```
conf
ë³µì‚¬í¸ì§‘
module(load="imudp")
input(type="imudp" port="514")

module(load="imtcp")
input(type="imtcp" port="514")

$template SimpleFormat,"%timestamp:::date-rfc3339% %hostname% %syslogtag% %msg%\n"
if $fromhost-ip == '192.168.40.2' then /var/log/messages
& stop

```

1. ë°©í™”ë²½ í™•ì¸ (UDP, TCP 514 í—ˆìš©)

```bash
bash
ë³µì‚¬í¸ì§‘
sudo firewall-cmd --add-port=514/udp --permanent
sudo firewall-cmd --add-port=514/tcp --permanent
sudo firewall-cmd --reload

```

1. RSyslog ì¬ì‹œì‘:

```bash
bash
ë³µì‚¬í¸ì§‘
sudo systemctl restart rsyslog

```

---

## âœ… [3] Cisco ì¥ë¹„ì—ì„œ ë¡œê·¸ ì „ì†¡ ì„¤ì •

Cisco IOSì—ì„œ ì•„ë˜ ëª…ë ¹ ì‹¤í–‰:

```
c
ë³µì‚¬í¸ì§‘
conf t
logging host 192.168.50.10  â† (ë¦¬ëˆ…ìŠ¤ ì„œë²„ IP)
logging trap informational
exit

```

í™•ì¸ìš© í…ŒìŠ¤íŠ¸ ëª…ë ¹ì–´:

```
cisco
ë³µì‚¬í¸ì§‘
send log msg "Test log message from CLI"

```

---

## âœ… [4] ë¡œê·¸ ìˆ˜ì‹  í™•ì¸

```bash
bash
ë³µì‚¬í¸ì§‘
tail -f /var/log/messages

```

ì˜ˆì‹œ ì¶œë ¥:

```
nginx
ë³µì‚¬í¸ì§‘
Aug  1 00:57:03 192.168.40.2 406: *Mar  2 01:53:10.410: %SYS-2-LOGMSG: Message from 0(): msg "Test log message from CLI"

```

---

## âœ… [5] Python ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± (`/var/lib/pgsql/syslogp.py`)

```python
python
ë³µì‚¬í¸ì§‘
import psycopg2
import re
from datetime import datetime

conn = psycopg2.connect(
    dbname="syslog",
    user="syslogdb",
    password="password",
    host="127.0.0.1",
    port="5432"
)
cur = conn.cursor()

logfile = '/var/log/messages'

with open(logfile, 'r') as f:
    for line in f:
        m = re.match(r'^(\w{3}\s+\d+\s+\d{2}:\d{2}:\d{2})\s+(\S+)\s+\d+: \*(.*)', line)
        if m:
            log_time_str, hostname, message = m.groups()
            try:
                log_time = datetime.strptime(log_time_str, '%b %d %H:%M:%S')
                log_time = log_time.replace(year=datetime.now().year)
            except ValueError:
                continue
            cur.execute("""
                INSERT INTO tacacs_logs (log_time, hostname, service, message)
                VALUES (%s, %s, %s, %s)
            """, (log_time, hostname, 'SYSLOG', message))

conn.commit()
cur.close()
conn.close()

```

---

## âœ… [6] ì‹¤í–‰ ë° í™•ì¸

1. íŒŒì„œ ì‹¤í–‰:

```bash
bash
ë³µì‚¬í¸ì§‘
python3 /var/lib/pgsql/syslogp.py

```

1. DBì—ì„œ ê²°ê³¼ í™•ì¸:

```bash
bash
ë³µì‚¬í¸ì§‘
psql -U syslogdb -d syslog
SELECT * FROM tacacs_logs ORDER BY id DESC LIMIT 10;

```

---

# ğŸ”š ë§ˆë¬´ë¦¬ ë° ë‹¤ìŒ ë‹¨ê³„

- [ ]  `cron`ìœ¼ë¡œ ìë™í™”í•˜ê±°ë‚˜
- [ ]  `tail -F` ë°©ì‹ìœ¼ë¡œ ì‹ ê·œ ë¡œê·¸ë§Œ íŒŒì‹±í•˜ê²Œ ë§Œë“¤ ìˆ˜ë„ ìˆìŒ
- [ ]  ë‹¤ì–‘í•œ ì¥ë¹„ ì§€ì›í•˜ë ¤ë©´ ì •ê·œí‘œí˜„ì‹ ê°œì„  í•„ìš”